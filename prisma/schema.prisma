generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("ADMIN_DATABASE_URL")
}

// ============================================================
// ADMIN USERS - Usuários do backoffice Grayskull
// ============================================================

model AdminUser {
  id           String    @id @default(uuid())
  email        String    @unique
  password     String
  name         String
  role         AdminRole @default(OPERATOR)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  auditLogs AuditLog[]

  @@map("admin_users")
}

enum AdminRole {
  SUPER_ADMIN  // Acesso total
  ADMIN        // Gerencia tudo exceto outros admins
  OPERATOR     // Apenas visualização e operações básicas
  SUPPORT      // Suporte técnico
}

// ============================================================
// PLANS - Planos disponíveis
// ============================================================

model Plan {
  id           String   @id @default(uuid())
  code         String   @unique // basic, professional, enterprise
  name         String
  description  String?
  price        Decimal  @db.Decimal(10, 2)
  billingCycle BillingCycle @default(MONTHLY)
  maxUsers     Int      @default(5)
  maxBranches  Int      @default(1)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  modules       PlanModule[]
  subscriptions Subscription[]

  @@map("plans")
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  SEMIANNUAL
  ANNUAL
}

// ============================================================
// MODULES - Módulos disponíveis no sistema
// ============================================================

model Module {
  id          String   @id @default(uuid())
  code        String   @unique // core, hr, fleet, stock, financial, chat, custom_whatsapp
  name        String
  description String?
  version     String   @default("1.0.0")
  isCore      Boolean  @default(false) // Módulos obrigatórios (sempre incluídos)
  isCustom    Boolean  @default(false) // Módulo personalizado (específico de cliente)
  isActive    Boolean  @default(true)
  
  // Campos para módulos personalizados
  repositoryUrl  String?  // URL do repositório no GitHub (apenas referência/link)
  modulePath     String?  // Nome da pasta do projeto (ex: grayskull-baileys-service)
  migrationsPath String?  // Subpasta das migrations dentro do projeto (padrão: prisma)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  plans   PlanModule[]
  tenants TenantModule[]

  @@map("modules")
}

model PlanModule {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  planId String
  plan   Plan @relation(fields: [planId], references: [id], onDelete: Cascade)

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([planId, moduleId])
  @@map("plan_modules")
}

// ============================================================
// TENANTS - Empresas clientes
// ============================================================

model Tenant {
  id            String       @id @default(uuid())
  code          String       @unique // Código único do tenant (ex: empresa-abc)
  name          String
  tradeName     String?      // Nome fantasia
  document      String       @unique // CNPJ
  email         String
  phone         String?
  
  // Configurações do banco de dados do cliente
  databaseHost  String?
  databasePort  Int?         @default(5432)
  databaseName  String?
  databaseUser  String?
  databasePass  String?      // Criptografado
  
  // Status
  status        TenantStatus @default(PENDING)
  isProvisioned Boolean      @default(false) // Banco já foi criado?
  provisionedAt DateTime?
  
  // Configurações
  timezone      String       @default("America/Sao_Paulo")
  locale        String       @default("pt-BR")
  
  // Metadata
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  subscription Subscription?
  modules      TenantModule[]
  contacts     TenantContact[]
  auditLogs    AuditLog[]

  @@map("tenants")
}

enum TenantStatus {
  PENDING      // Aguardando configuração
  TRIAL        // Em período de teste
  ACTIVE       // Ativo e pagando
  SUSPENDED    // Suspenso (inadimplência)
  CANCELLED    // Cancelado
}

model TenantContact {
  id        String   @id @default(uuid())
  name      String
  email     String
  phone     String?
  role      String?  // Diretor, Gerente, TI, Financeiro
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_contacts")
}

model TenantModule {
  id              String    @id @default(uuid())
  isEnabled       Boolean   @default(true)
  enabledAt       DateTime  @default(now())
  disabledAt      DateTime?
  config          String?   // JSON com configurações específicas do módulo para este tenant
  
  // Controle de migrations
  schemaVersion   String?   // Versão do schema aplicada (ex: "1.0.0")
  migrationsApplied Boolean @default(false) // Se as migrations já foram executadas
  migrationsAppliedAt DateTime? // Quando as migrations foram aplicadas
  
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  moduleId String
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([tenantId, moduleId])
  @@map("tenant_modules")
}

// ============================================================
// SUBSCRIPTIONS - Assinaturas
// ============================================================

model Subscription {
  id              String             @id @default(uuid())
  status          SubscriptionStatus @default(TRIAL)
  trialEndsAt     DateTime?
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  cancelledAt     DateTime?
  cancelReason    String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  tenantId String @unique
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  invoices Invoice[]

  @@map("subscriptions")
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

// ============================================================
// BILLING - Faturas
// ============================================================

model Invoice {
  id            String        @id @default(uuid())
  number        String        @unique
  amount        Decimal       @db.Decimal(10, 2)
  dueDate       DateTime
  paidAt        DateTime?
  status        InvoiceStatus @default(PENDING)
  paymentMethod String?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

// ============================================================
// AUDIT LOG - Log de auditoria
// ============================================================

model AuditLog {
  id          String   @id @default(uuid())
  action      String   // CREATE, UPDATE, DELETE, LOGIN, etc
  entity      String   // Tenant, Subscription, etc
  entityId    String?
  oldData     String?  // JSON
  newData     String?  // JSON
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  adminUserId String?
  adminUser   AdminUser? @relation(fields: [adminUserId], references: [id])

  tenantId String?
  tenant   Tenant? @relation(fields: [tenantId], references: [id])

  @@index([entity, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}
